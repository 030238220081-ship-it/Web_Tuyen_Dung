{% extends 'recruitment/base.html' %}
{% block title %}Bài kiểm tra sàng lọc{% endblock %}

{% block content %}
<div class="card sticky-top mb-4 shadow-sm">
    <div class="card-body text-center">
        <h5 class="card-title mb-0">Thời gian còn lại: <span id="timer" class="fw-bold text-danger">--:--</span></h5>
    </div>
</div>

<h1>Bài kiểm tra cho vị trí: {{ application.job.title }}</h1>
<p>Hãy hoàn thành các câu hỏi dưới đây. Bài sẽ tự động nộp khi hết giờ.</p>
<form method="post" id="quiz-form">
    <!-- THÊM DÒNG NÀY ĐỂ KHẮC PHỤC LỖI -->
    {% csrf_token %}

    {% if mc_questions %}
    <h3 class="mt-4">Phần I: Trắc nghiệm</h3>
    {% for question in mc_questions %}
    <div class="card my-3">
        <div class="card-header">{{ forloop.counter }}. {{ question.text }}</div>
        <div class="card-body">
            {% for answer in question.answers.all %}
            <div class="form-check">
                <input class="form-check-input" type="radio" name="question_{{ question.id }}" id="answer_{{ answer.id }}" value="{{ answer.id }}" required>
                <label class="form-check-label" for="answer_{{ answer.id }}">{{ answer.text }}</label>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endfor %}
    {% endif %}

    {% if essay_questions %}
    <h3 class="mt-4">Phần II: Tự luận</h3>
    {% for question in essay_questions %}
    <div class="card my-3">
        <div class="card-header">{{ forloop.counter }}. {{ question.text }}</div>
        <div class="card-body">
            <textarea name="question_{{ question.id }}" class="form-control" rows="5" required></textarea>
        </div>
    </div>
    {% endfor %}
    {% endif %}

    <button type="submit" class="btn btn-primary">Nộp bài</button>
</form>

<script>
    const timeLimitMinutes = {{ time_limit }};
    const quizForm = document.getElementById('quiz-form');
    const timerDisplay = document.getElementById('timer');

    // Tính toán thời gian kết thúc
    const endTime = new Date().getTime() + timeLimitMinutes * 60 * 1000;

    // Cập nhật đồng hồ mỗi giây
    const timerInterval = setInterval(function() {
        const now = new Date().getTime();
        const distance = endTime - now;

        // Tính toán phút và giây
        const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((distance % (1000 * 60)) / 1000);

        // Hiển thị kết quả
        timerDisplay.textContent = minutes.toString().padStart(2, '0') + ":" + seconds.toString().padStart(2, '0');

        // Khi hết giờ
        if (distance < 0) {
            clearInterval(timerInterval);
            timerDisplay.textContent = "Hết giờ!";
            alert('Đã hết thời gian làm bài. Bài của bạn sẽ được nộp tự động.');
            quizForm.submit();
        }
    }, 1000);
</script>
{% endblock %}