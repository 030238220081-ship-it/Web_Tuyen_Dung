{% extends 'recruitment/base.html' %}
{% block title %}AI Nh·∫≠n x√©t CV{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-10">
        <div class="card shadow-sm">
            <div class="card-body p-4">
                <div class="text-center mb-4">
                    <h1 class="h2">ü§ñ AI Nh·∫≠n x√©t CV ü§ñ</h1>
                    <p class="text-muted">Ch·ªçn m·ªôt v·ªã tr√≠ ƒëang tuy·ªÉn ƒë·ªÉ nh·∫≠n ƒë√°nh gi√° CV c·ªßa b·∫°n.</p>
                </div>

                <div class="mb-3">
                    {% if user.profile.cv_file %}
                        <div class="alert alert-success">
                            <i class="bi bi-check-circle-fill"></i> ƒê√£ nh·∫≠n di·ªán CV c·ªßa b·∫°n: <strong>{{ user.profile.cv_file.name|slice:"4:" }}</strong>.
                        </div>
                    {% else %}
                        <div class="alert alert-warning">
                            <i class="bi bi-exclamation-triangle-fill"></i> B·∫°n ch∆∞a t·∫£i l√™n CV. Vui l√≤ng <a href="{% url 'profile' %}" class="alert-link">c·∫≠p nh·∫≠t CV</a> tr∆∞·ªõc.
                        </div>
                    {% endif %}
                </div>
                
                <div class="mb-3">
                    <label for="jd_select" class="form-label fw-bold">Ch·ªçn v·ªã tr√≠ c√¥ng vi·ªác b·∫°n mu·ªën ph√¢n t√≠ch:</label>
                    <select class="form-select" id="jd_select">
                        <option selected disabled value="">‚Äî Vui l√≤ng ch·ªçn m·ªôt v·ªã tr√≠ ‚Äî</option>
                        {% for job in jobs %}
                            <option value="{{ job.id }}">{{ job.title }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="d-grid">
                    <button class="btn btn-primary btn-lg" onclick="analyzeCV()" id="analyze-button" {% if not user.profile.cv_file %}disabled{% endif %}>
                        <span id="button-text">Ph√¢n t√≠ch & Nh·∫≠n x√©t CV</span>
                        <span id="spinner" class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                    </button>
                </div>
                
                <hr class="my-4">

                <div id="results-container" class="d-none">
                    <h3 class="text-center mb-3">K·∫øt qu·∫£ Ph√¢n t√≠ch</h3>
                    
                    <div class="mb-4">
                        <h5 class="text-center">M·ª©c ƒë·ªô ph√π h·ª£p</h5>
                        <div class="progress" style="height: 25px;">
                            <div id="score-bar" class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <div class="card h-100">
                                <div class="card-header bg-success text-white">
                                    <i class="bi bi-hand-thumbs-up-fill"></i> <strong>ƒêi·ªÉm m·∫°nh</strong>
                                </div>
                                <ul class="list-group list-group-flush" id="strengths-list"></ul>
                            </div>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <div class="card h-100">
                                <div class="card-header bg-warning text-dark">
                                    <i class="bi bi-lightbulb-fill"></i> <strong>G·ª£i √Ω c·∫£i thi·ªán</strong>
                                </div>
                                <ul class="list-group list-group-flush" id="suggestions-list"></ul>
                            </div>
                        </div>
                    </div>
                </div>
                </div>
        </div>
    </div>
</div>

<script>
    // Ph·∫ßn JavaScript gi·ªØ nguy√™n nh∆∞ c≈©
    async function analyzeCV() {
        const selectedJobId = document.getElementById('jd_select').value;
        if (!selectedJobId) {
            alert('Vui l√≤ng ch·ªçn m·ªôt v·ªã tr√≠ c√¥ng vi·ªác ƒë·ªÉ ph√¢n t√≠ch.');
            return;
        }

        const button = document.getElementById('analyze-button');
        const buttonText = document.getElementById('button-text');
        const spinner = document.getElementById('spinner');
        const resultsContainer = document.getElementById('results-container');

        button.disabled = true;
        buttonText.textContent = 'ƒêang ph√¢n t√≠ch...';
        spinner.classList.remove('d-none');
        resultsContainer.classList.add('d-none');

        try {
            const response = await fetch("{% url 'cv_review' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({ job_id: selectedJobId })
            });

            const result = await response.json();

            if (result.success) {
                displayResults(result.data);
            } else {
                alert('L·ªói: ' + result.error);
            }
        } catch (error) {
            console.error('Fetch error:', error);
            alert('ƒê√£ c√≥ l·ªói k·∫øt n·ªëi x·∫£y ra. Vui l√≤ng th·ª≠ l·∫°i.');
        } finally {
            button.disabled = false;
            buttonText.textContent = 'Ph√¢n t√≠ch & Nh·∫≠n x√©t CV';
            spinner.classList.add('d-none');
        }
    }

    function displayResults(data) {
        const scoreBar = document.getElementById('score-bar');
        scoreBar.style.width = data.score + '%';
        scoreBar.textContent = data.score + '%';
        scoreBar.setAttribute('aria-valuenow', data.score);

        const strengthsList = document.getElementById('strengths-list');
        strengthsList.innerHTML = '';
        data.strengths.forEach(item => {
            const li = document.createElement('li');
            li.className = 'list-group-item';
            li.textContent = item;
            strengthsList.appendChild(li);
        });

        const suggestionsList = document.getElementById('suggestions-list');
        suggestionsList.innerHTML = '';
        data.suggestions.forEach(item => {
            const li = document.createElement('li');
            li.className = 'list-group-item';
            li.textContent = item;
            suggestionsList.appendChild(li);
        });

        document.getElementById('results-container').classList.remove('d-none');
    }
</script>
{% endblock %}